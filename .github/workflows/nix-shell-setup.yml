name: Setup Nix Shell

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  test-nix-shell:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v13

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v7

      - name: Verify Nix shell environment
        run: |
          nix-shell --run "R --version"
          nix-shell --run "which pak || R -e 'packageVersion(\"pak\")'"

      - name: Make install script executable
        run: chmod +x install-packages-nix.sh

      - name: Install R packages in Nix shell
        run: |
          nix-shell --run "./install-packages-nix.sh"

      - name: Verify installed packages
        run: |
          nix-shell --run "R --quiet --no-save -e '
            installed <- installed.packages()
            github_pkgs <- c(\"rSharp\", \"ospsuite\", \"tlf\", \"ospsuite.utils\",
                            \"ospsuite.parameteridentification\", \"esqlabsR\")
            found <- github_pkgs[github_pkgs %in% installed[, \"Package\"]]
            message(\"GitHub packages installed: \", length(found), \"/\", length(github_pkgs))
            for (pkg in found) {
              message(sprintf(\"  âœ“ %s %s\", pkg, installed[pkg, \"Version\"]))
            }
          '"

